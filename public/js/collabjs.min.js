/*!
* collab.js v0.4.0
* Copyright (c) 2013 Denis Vuyka
* License: MIT
* http://www.opensource.org/licenses/mit-license.php
*/
function PostViewModel(data){"use strict";var self=this;self.id=data.id,self.account=data.account,self.name=data.name,self.content=data.content.twitterize(),self.created=moment(data.created),self.hashtags=data.content.getHashTags(),self.picture=collabjs.getUserPicture(data.pictureId,data.pictureSize),self.feed="/people/"+data.account+"/timeline",self.isOwnPost=data.account===collabjs.currentUser.account,self.postUrl="/timeline/posts/"+data.id,self.commentsCount=ko.observable(data.commentsCount?data.commentsCount:0),self.comments=ko.observableArray([]),self.commentsLoading=ko.observable(!1),self.commentsLoaded=!1,self.openBlank=!1,self.sortComments=function(){self.comments.sort(function(left,right){return left.created===right.created?0:left.created<right.created?-1:1})}}function FeedViewModel(data){"use strict";var self=this;self.posts=ko.observableArray([]),self.dismissPost=function(post){var token=$("#csrf_token").val();$.ajax({url:"/api/timeline/posts/"+post.id,type:"DELETE",headers:{"x-csrf-token":token},success:function(){self.posts.remove(post),$(document).trigger("collabjs.onPostRemoved",data)}})},self.addNewPost=function(post){var viewmodel=new PostViewModel(post);self.posts.unshift(viewmodel)},self.createPost=function(data){var viewmodel=new PostViewModel(data);if(data.comments&&data.comments.length>0){var entries=ko.utils.arrayMap(data.comments,function(entry){return new PostViewModel({id:entry.id,account:entry.account,name:entry.name,content:entry.content,created:entry.created,pictureSize:48,pictureId:entry.pictureId})});viewmodel.comments(entries),viewmodel.commentsLoaded=!0}return viewmodel.openBlank=viewmodel.commentsLoaded===!1&&viewmodel.commentsCount()>9,viewmodel},self.addPost=function(data){var viewmodel=self.createPost(data);self.posts.push(viewmodel)},self.appendPosts=function(posts){var newItems=ko.utils.arrayMap(posts,function(entry){return self.createPost(entry)});self.posts.push.apply(self.posts,newItems)},self.appendPosts(data)}function UserProfileViewModel(data){"use strict";var self=this;self.id=data.id,self.account=data.account,self.name=data.name,self.location=data.location,self.website=data.website,self.bio=data.bio,self.posts=data.posts,self.followers=data.followers,self.following=data.following,self.isFollowed=ko.observable(data.isFollowed),self.isOwnProfile=data.isOwnProfile,self.picture=collabjs.getUserPicture(data.pictureId),self.feed="/people/"+data.account+"/timeline",self.followingUrl="/people/"+data.account+"/following",self.followersUrl="/people/"+data.account+"/followers",self.followAction="/api/people/"+data.account+"/follow",self.unfollowAction="/api/people/"+data.account+"/unfollow",self.canFollow=ko.computed(function(){return!self.isFollowed()&&!self.isOwnProfile},this),self.canUnfollow=ko.computed(function(){return self.isFollowed()&&!self.isOwnProfile},this),self.follow=function(profile){$.get(profile.followAction,function(){profile.isFollowed(!0)})},self.unfollow=function(profile){$.get(profile.unfollowAction,function(){profile.isFollowed(!1)})}}function PeopleViewModel(data){"use strict";var self=this;self.profiles=ko.observableArray([]),self.appendItems=function(items){var newItems=ko.utils.arrayMap(items,function(entry){return new UserProfileViewModel(entry)});self.profiles.push.apply(self.profiles,newItems)},self.follow=function(profile){$.get(profile.followAction,function(){profile.isFollowed(!0)})},self.unfollow=function(profile){$.get(profile.unfollowAction,function(){profile.isFollowed(!1)})},self.appendItems(data)}function initLazyLoading(url,onSuccess){"use strict";$(window).scroll(function(){if($(window).scrollTop()===$(document).height()-$(window).height()&&_page>-1&&!_inCallback){_inCallback=!0,_page++;var pageSpinner=$(".page-spinner"),pageError=$(".page-error");pageSpinner.show(),pageError.hide(),$.ajax({type:"GET",dataType:"json",url:url(_page),timeout:5e3,success:function(data){data.length>0?onSuccess&&"function"==typeof onSuccess&&onSuccess(data):_page=-1},error:function(){pageError.text("Error getting data. There seems to be a server problem, please try again later."),pageError.show(),_page--},complete:function(){_inCallback=!1,pageSpinner.hide()}})}})}var collabjs=collabjs||{avatarServer:"https://www.gravatar.com",currentUser:{id:null,account:null,pictureId:null,getPictureUrl:function(){"use strict";return collabjs.getUserPicture(collabjs.currentUser.pictureId,48)}},getUserPicture:function(pictureId,pictureSize){"use strict";return collabjs.avatarServer+"/avatar/"+pictureId+"?s="+(pictureSize||"48")},ui:{},utils:{isNullOrWhiteSpace:function(str){"use strict";return null===str||null!==str.match(/^ *$/)}}};collabjs.countries={AF:"Afghanistan",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BR:"Brazil",VG:"British Virgin Islands",BN:"Brunei",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",CI:"Côte d'Ivoire",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CO:"Colombia",KM:"Comoros",CG:"Congo",CR:"Costa Rica",HR:"Croatia",CU:"Cuba",CY:"Cyprus",CZ:"Czech Republic",CD:"Democratic Republic of the Congo",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",TP:"East Timor",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FO:"Faeroe Islands",FK:"Falkland Islands",FJ:"Fiji",FI:"Finland",MK:"Former Yugoslav Republic of Macedonia",FR:"France",GA:"Gabon",GE:"Georgia",DE:"Germany",GH:"Ghana",GR:"Greece",GL:"Greenland",GD:"Grenada",GU:"Guam",GT:"Guatemala",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Laos",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macau",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MR:"Mauritania",MU:"Mauritius",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NF:"Norfolk Island",KP:"North Korea",MP:"Northern Marianas",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn Islands",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RO:"Romania",RU:"Russia",RW:"Rwanda",ST:"São Tomé and Príncipe",SH:"Saint Helena",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",VC:"Saint Vincent and the Grenadines",WS:"Samoa",SM:"San Marino",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia and the South Sandwich Islands",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syria",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",BS:"The Bahamas",GM:"The Gambia",TG:"Togo",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",VI:"US Virgin Islands",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VA:"Vatican City",VE:"Venezuela",VN:"Vietnam",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"},function($){"use strict";$.fn.countdown=function(config){function updateUi(sender){var available=options.limit-$(sender).val().length,counter=options.prefix+available+options.suffix;counter>=0?options.plus(counter):options.minus(counter)}var options=$.extend($.fn.countdown.defaults,config);return updateUi($(this)),this.each(function(){$(this).bind("keyup change",function(){return $(this).val().length?(updateUi($(this)),void 0):(options.init(options.limit),void 0)})})},$.fn.countdown.defaults={limit:160,init:function(){},plus:function(){},minus:function(){},prefix:"",suffix:""}}(jQuery),$(function(){"use strict";ko.bindingHandlers.country={init:function(){},update:function(element,valueAccessor){var $element=$(element),valueUnwrapped=ko.utils.unwrapObservable(valueAccessor());if(valueUnwrapped&&valueUnwrapped.length>0){$element.css("display","block");var content='<i class="flag-icon-16 flag-'+valueUnwrapped.toLowerCase()+'"></i>';content+=collabjs.countries[valueUnwrapped.toUpperCase()],$element.empty().html(content)}else $element.css("display","none")}}}),String.prototype.formatString=function(){"use strict";for(var formatted=this,i=0;i<arguments.length;i++){var regexp=new RegExp("\\{"+i+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted},String.prototype.parseUrls=function(){"use strict";return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g,function(url){return url.link(url)})},String.prototype.parseHashTags=function(){"use strict";return this.replace(/[#]+[A-Za-z0-9-_]+/g,function(t){var tag=t.replace("#","%23");return t.link("/search?q="+tag+"&src=hash")})},String.prototype.parseAccountTags=function(){"use strict";return this.replace(/[@]+[A-Za-z0-9-_]+/g,function(u){var username=u.replace("@","");return"<a href='/people/"+username+"/timeline'>"+u+"</a>"})},String.prototype.getHashTags=function(){"use strict";var result=this.match(/[#]+[A-Za-z0-9-_]+/g);return result?result:[]},String.prototype.twitterize=function(){"use strict";return this.parseUrls().parseAccountTags().parseHashTags()},collabjs.ui.onFeedDataLoaded=function(data){"use strict";var feed=data||[];window.timelineFeed?window.timelineFeed.appendPosts(feed):(window.timelineFeed=new FeedViewModel(feed),ko.applyBindings(window.timelineFeed)),collabjs.ui.enableCommentExpanders()},collabjs.ui.onPeopleLoaded=function(data){"use strict";var feed=[];if(data&&data.feed&&(feed=data.feed),window.peopleFeed)window.peopleFeed.appendItems(feed);else{var model=new PeopleViewModel(feed);data.user&&(model.user=new UserProfileViewModel(data.user)),window.peopleFeed=model,ko.applyBindings(model)}},collabjs.ui.onTimelineLoaded=function(data){"use strict";var feed=[];if(data&&data.feed&&(feed=data.feed),window.timelineFeed)window.timelineFeed.appendPosts(feed);else{var model=new FeedViewModel(feed);data.user&&(model.user=new UserProfileViewModel(data.user)),window.timelineFeed=model,ko.applyBindings(model)}collabjs.ui.enableCommentExpanders()},$(document).bind("collabjs.onStatusUpdated",function(event,data){"use strict";var feed=window.timelineFeed;data&&feed&&data.account===collabjs.currentUser.account&&window.timelineFeed.addNewPost(data)}),collabjs.ui.enableCommentExpanders=function(){"use strict";function onCommentsExpanded(e){e.preventDefault();var sender=$(e.target),post=ko.dataFor(sender[0]);post.commentsLoading()||(post.commentsLoading(!0),$.ajax({url:"/api/timeline/posts/"+post.id+"/comments",dataType:"json",success:function(data){onCommentsLoaded(post,data)}}))}function onCommentsLoaded(post,data){if(post.commentsLoading(!1),data){post.commentsCount(data.length);var newItems=ko.utils.arrayMap(data,function(entry){return new PostViewModel({id:entry.id,account:entry.account,name:entry.name,content:entry.content,created:entry.created,pictureSize:48,pictureId:entry.pictureId})});post.comments(newItems)}else post.comments([])}var comments=$('a[data-link-type="comment"]');comments.unbind("click",onCommentsExpanded),comments.bind("click",onCommentsExpanded)},collabjs.ui.doPostComment=function(form){"use strict";var formData=$(form).serialize();$.post("/api/timeline/comments",formData,function(data){var editor=$("#comment-box-"+data.postId),post=ko.dataFor(editor[0]);post.commentsCount(post.commentsCount()+1),post.comments.push(new PostViewModel({id:data.id,account:data.account,name:data.name,content:data.content,created:data.created,pictureSize:48,pictureId:data.pictureId})),post.sortComments(),editor.val("")})},collabjs.ui.initRegisterView=function(){"use strict";$(function(){$("input").not(["type=submit"]).jqBootstrapValidation()})},collabjs.ui.initChangePasswordView=function(){"use strict";$(function(){$("input").not(["type=submit"]).jqBootstrapValidation()})},collabjs.ui.initPostView=function(id){"use strict";function onPostLoaded(data){data?(window.viewmodel=new FeedViewModel([data]),ko.applyBindings(window.viewmodel)):$(".page-error").text("Post not found.").show()}$(document).ready(function(){var spinner=$(".page-spinner");spinner.show(),$.ajax({type:"GET",url:"/api/timeline/posts/"+id,success:onPostLoaded,error:function(){$(".page-error").text("Post not found.").show()},complete:function(){spinner.hide()}})})},collabjs.ui.initTimeline=function(){"use strict";function onUpdatesLoaded(data){data&&window.timelineFeed&&($(data).each(function(index,post){window.timelineFeed.addNewPost(post)}),collabjs.ui.enableCommentExpanders())}function checkNewPosts(){clearTimeout(updateChecker),updateChecker=setTimeout(function(){var topId=Math.max.apply(this,$.map(window.timelineFeed.posts(),function(o){return o.id})),notifier=$("#msg-new-posts");$.get("/api/timeline/updates/count?topId="+topId,function(data){data&&data.posts&&data.posts>0?($("#new-msg-counter").text(data.posts),notifier.show()):notifier.hide()},"json").always(function(){checkNewPosts()})},6e4)}$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/timeline/posts",collabjs.ui.onFeedDataLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var posts=window.timelineFeed.posts(),bottomPostId=0;return posts.length>0&&(bottomPostId=Math.min.apply(this,$.map(posts,function(p){return p.id}))),"/api/timeline/posts?topId="+bottomPostId},collabjs.ui.onFeedDataLoaded),checkNewPosts()});var updateChecker;$("#new-msg-link").on("click",function(e){e.preventDefault(),$("#msg-new-posts").hide(),clearTimeout(updateChecker);var topId=Math.max.apply(this,$.map(window.timelineFeed.posts(),function(o){return o.id}));$.get("/api/timeline/updates?topId="+topId,function(data){onUpdatesLoaded(data)},"json").always(function(){checkNewPosts()})})},collabjs.ui.doUpdateStatus=function(form){"use strict";var f=$(form),data=f.serialize(),input=f.find(":input");input.attr("disabled",!0),$.post("/api/timeline/posts",data,function(result){input.removeAttr("disabled"),f.find("textarea").val(""),$(document).trigger("collabjs.onStatusUpdated",result)})},collabjs.ui.initMentions=function(){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/mentions",collabjs.ui.onTimelineLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var posts=window.timelineFeed.posts(),bottomPostId=0;return posts.length>0&&(bottomPostId=Math.min.apply(this,$.map(posts,function(p){return p.id}))),"/api/mentions?topId="+bottomPostId},collabjs.ui.onTimelineLoaded)})},collabjs.ui.initPeople=function(){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/people",collabjs.ui.onPeopleLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var profiles=window.peopleFeed.profiles(),bottomUserId=0;return profiles.length>0&&(bottomUserId=Math.max.apply(this,$.map(profiles,function(u){return u.id}))),"/api/people?topId="+bottomUserId},collabjs.ui.onPeopleLoaded)})},collabjs.ui.initFollowers=function(account){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/people/"+account+"/followers",collabjs.ui.onPeopleLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var profiles=window.peopleFeed.profiles(),bottomUserId=0;return profiles.length>0&&(bottomUserId=Math.max.apply(this,$.map(profiles,function(u){return u.id}))),"/api/people/"+account+"/followers?topId="+bottomUserId},collabjs.ui.onPeopleLoaded)})},collabjs.ui.initFollowing=function(account){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/people/"+account+"/following",collabjs.ui.onPeopleLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var profiles=window.peopleFeed.profiles(),bottomUserId=0;return profiles.length>0&&(bottomUserId=Math.max.apply(this,$.map(profiles,function(u){return u.id}))),"/api/people/"+account+"/following?topId="+bottomUserId},collabjs.ui.onPeopleLoaded)})},collabjs.ui.initPersonalTimeline=function(account){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/people/"+account+"/timeline",collabjs.ui.onTimelineLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var posts=window.timelineFeed.posts(),bottomPostId=0;return posts.length>0&&(bottomPostId=Math.min.apply(this,$.map(posts,function(p){return p.id}))),"/api/people/"+account+"/timeline?topId="+bottomPostId},collabjs.ui.onTimelineLoaded)})},collabjs.ui.initAccountView=function(){"use strict";$(document).ready(function(){function formatCountry(entry){return entry.id?'<i class="flag-icon-16 flag-'+entry.id.toLowerCase()+'"></i>'+entry.text:entry.text}$("#bio").countdown({limit:160,init:function(counter){$("#bio_counter").css("color","#999").text(counter)},plus:function(counter){$("#bio_counter").css("color","#999").text(counter),$("#submit").removeAttr("disabled")},minus:function(counter){$("#bio_counter").css("color","red").text(counter),$("#submit").attr("disabled","disabled")}});var countryData=[];for(var key in collabjs.countries)collabjs.countries.hasOwnProperty(key)&&countryData.push({id:key,text:collabjs.countries[key]});var locationValue=$("#location").data("location");$("#location").select2({placeholder:"Select a Country",allowClear:!0,data:countryData,formatResult:formatCountry,formatSelection:formatCountry}).select2("val",locationValue)})},collabjs.ui.initSearchPosts=function(q,src){"use strict";$(document).ready(function(){var pageSpinner=$(".page-spinner");pageSpinner.show(),$.get("/api/search?q="+encodeURIComponent(q)+"&src="+src,collabjs.ui.onFeedDataLoaded).always(function(){pageSpinner.hide()}),initLazyLoading(function(){var posts=window.timelineFeed.posts(),bottomPostId=0;return posts.length>0&&(bottomPostId=Math.min.apply(this,$.map(posts,function(p){return p.id}))),"/api/search?q="+encodeURIComponent(q)+"&src="+src+"&topId="+bottomPostId},collabjs.ui.onFeedDataLoaded)})};var _page=0,_inCallback=!1;collabjs.ui.requestPath="",collabjs.ui.syncSelection=function(){"use strict";var path=collabjs.ui.requestPath||window.location.pathname+window.location.search;$('.nav li a[href="'+path+'"]').parents("li").addClass("active"),$('a.list-group-item[href="'+path+'"]').addClass("active")},$(function(){"use strict";collabjs.ui.syncSelection()});